(window.webpackJsonp=window.webpackJsonp||[]).push([[77],{2246:function(e,t,r){"use strict";var n=this&&this.__assign||Object.assign||function(e){for(var s,i=1,t=arguments.length;i<t;i++)for(var p in s=arguments[i])Object.prototype.hasOwnProperty.call(s,p)&&(e[p]=s[p]);return e},o=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,c){function d(e){try{h(n.next(e))}catch(e){c(e)}}function l(e){try{h(n.throw(e))}catch(e){c(e)}}function h(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(d,l)}h((n=n.apply(e,t||[])).next())}))},c=this&&this.__generator||function(e,body){var t,r,n,g,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return g={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(g[Symbol.iterator]=function(){return this}),g;function c(c){return function(d){return function(c){if(t)throw new TypeError("Generator is already executing.");for(;o;)try{if(t=1,r&&(n=2&c[0]?r.return:c[0]?r.throw||((n=r.return)&&n.call(r),0):r.next)&&!(n=n.call(r,c[1])).done)return n;switch(r=0,n&&(c=[2&c[0],n.value]),c[0]){case 0:case 1:n=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,r=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==c[0]&&2!==c[0])){o=0;continue}if(3===c[0]&&(!n||c[1]>n[0]&&c[1]<n[3])){o.label=c[1];break}if(6===c[0]&&o.label<n[1]){o.label=n[1],n=c;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(c);break}n[2]&&o.ops.pop(),o.trys.pop();continue}c=body.call(e,o)}catch(e){c=[6,e],r=0}finally{t=n=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,d])}}};Object.defineProperty(t,"__esModule",{value:!0});var d=r(1209),l=r(564),h=r(1231),m=r(1247),y=r(1248),v=r(1249),A=r(328),f=r(752),_=r(1251),w=r(2563),T=r(73),k=r(2564),P=r(157),E=r(585),S=function(){function e(e,t,r){void 0===t&&(t={}),this.gasPriceAddition=new T.BigNumber(3),this.gasIncreaseFactor=E.DEFAULT_GAS_INCREASE_FACTOR,t.networkName=t.networkName||A.Network.Main,t.gasPrice=t.gasPrice||f.makeBigNumber(3e5),this.api=new y.OpenSeaAPI(t),this._networkName=t.networkName;var n=new d.providers.HttpProvider(this._networkName==A.Network.Main?E.MAINNET_PROVIDER_URL:E.RINKEBY_PROVIDER_URL);this.web3=new d(e),this.web3ReadOnly=new d(n),this._wyvernProtocol=new l.WyvernProtocol(e,{network:this._networkName,gasPrice:t.gasPrice}),this._wyvernProtocolReadOnly=new l.WyvernProtocol(n,{network:this._networkName,gasPrice:t.gasPrice}),this._wrappedNFTFactoryAddress=this._networkName==A.Network.Main?E.WRAPPED_NFT_FACTORY_ADDRESS_MAINNET:E.WRAPPED_NFT_FACTORY_ADDRESS_RINKEBY,this._wrappedNFTLiquidationProxyAddress=this._networkName==A.Network.Main?E.WRAPPED_NFT_LIQUIDATION_PROXY_ADDRESS_MAINNET:E.WRAPPED_NFT_LIQUIDATION_PROXY_ADDRESS_RINKEBY,this._uniswapFactoryAddress=this._networkName==A.Network.Main?E.UNISWAP_FACTORY_ADDRESS_MAINNET:E.UNISWAP_FACTORY_ADDRESS_RINKEBY,this._emitter=new k.EventEmitter,this.logger=r||function(e){return e}}return e.prototype.addListener=function(e,t,r){return void 0===r&&(r=!1),r?this._emitter.once(e,t):this._emitter.addListener(e,t)},e.prototype.removeListener=function(e){e.remove()},e.prototype.removeAllListeners=function(e){this._emitter.removeAllListeners(e)},e.prototype.wrapAssets=function(e){var t=e.assets,r=e.accountAddress;return o(this,void 0,void 0,(function(){var e,n,o,d,l,h,m,y=this;return c(this,(function(c){switch(c.label){case 0:return e=this._getSchema(A.WyvernSchemaName.ERC721),n=t.map((function(a){return f.getWyvernAsset(e,a)})),o=n.map((function(a){return a.id})),d=n.map((function(a){return a.address})),l=!d.every((function(e,i,t){return e===t[0]})),this._dispatch(A.EventType.WrapAssets,{assets:n,accountAddress:r}),[4,this._computeGasPrice()];case 1:return h=c.sent(),[4,f.sendRawTransaction(this.web3,{from:r,to:this._wrappedNFTLiquidationProxyAddress,value:0,data:_.encodeCall(v.getMethod(v.WrappedNFTLiquidationProxy,"wrapNFTs"),[o,d,l]),gasPrice:h},(function(e){y._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:r})}))];case 2:return m=c.sent(),[4,this._confirmTransaction(m,A.EventType.WrapAssets,"Wrapping Assets")];case 3:return c.sent(),[2]}}))}))},e.prototype.unwrapAssets=function(e){var t=e.assets,r=e.destinationAddresses,n=e.accountAddress;return o(this,void 0,void 0,(function(){var e,o,d,l,h,m,y,w=this;return c(this,(function(c){switch(c.label){case 0:if(!t||!r||t.length!=r.length)throw new Error("The 'assets' and 'destinationAddresses' arrays must exist and have the same length.");return e=this._getSchema(A.WyvernSchemaName.ERC721),o=t.map((function(a){return f.getWyvernAsset(e,a)})),d=o.map((function(a){return a.id})),l=o.map((function(a){return a.address})),h=!l.every((function(e,i,t){return e===t[0]})),this._dispatch(A.EventType.UnwrapAssets,{assets:o,accountAddress:n}),[4,this._computeGasPrice()];case 1:return m=c.sent(),[4,f.sendRawTransaction(this.web3,{from:n,to:this._wrappedNFTLiquidationProxyAddress,value:0,data:_.encodeCall(v.getMethod(v.WrappedNFTLiquidationProxy,"unwrapNFTs"),[d,l,r,h]),gasPrice:m},(function(e){w._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:n})}))];case 2:return y=c.sent(),[4,this._confirmTransaction(y,A.EventType.UnwrapAssets,"Unwrapping Assets")];case 3:return c.sent(),[2]}}))}))},e.prototype.liquidateAssets=function(e){var t=e.assets,r=e.accountAddress,n=e.uniswapSlippageAllowedInBasisPoints;return o(this,void 0,void 0,(function(){var e,o,d,l,h,m,y,w,T=this;return c(this,(function(c){switch(c.label){case 0:return e=0===n?E.DEFAULT_WRAPPED_NFT_LIQUIDATION_UNISWAP_SLIPPAGE_IN_BASIS_POINTS:n,o=this._getSchema(A.WyvernSchemaName.ERC721),d=t.map((function(a){return f.getWyvernAsset(o,a)})),l=d.map((function(a){return a.id})),h=d.map((function(a){return a.address})),m=!h.every((function(e,i,t){return e===t[0]})),this._dispatch(A.EventType.LiquidateAssets,{assets:d,accountAddress:r}),[4,this._computeGasPrice()];case 1:return y=c.sent(),[4,f.sendRawTransaction(this.web3,{from:r,to:this._wrappedNFTLiquidationProxyAddress,value:0,data:_.encodeCall(v.getMethod(v.WrappedNFTLiquidationProxy,"liquidateNFTs"),[l,h,m,e]),gasPrice:y},(function(e){T._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:r})}))];case 2:return w=c.sent(),[4,this._confirmTransaction(w,A.EventType.LiquidateAssets,"Liquidating Assets")];case 3:return c.sent(),[2]}}))}))},e.prototype.purchaseAssets=function(e){var t=e.numTokensToBuy,r=e.amount,n=e.contractAddress,d=e.accountAddress;return o(this,void 0,void 0,(function(){var e,o,l=this;return c(this,(function(c){switch(c.label){case 0:return h.tokens[this._networkName].canonicalWrappedEther,this._dispatch(A.EventType.PurchaseAssets,{amount:r,contractAddress:n,accountAddress:d}),[4,this._computeGasPrice()];case 1:return e=c.sent(),[4,f.sendRawTransaction(this.web3,{from:d,to:this._wrappedNFTLiquidationProxyAddress,value:r,data:_.encodeCall(v.getMethod(v.WrappedNFTLiquidationProxy,"purchaseNFTs"),[t,n]),gasPrice:e},(function(e){l._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:d})}))];case 2:return o=c.sent(),[4,this._confirmTransaction(o,A.EventType.PurchaseAssets,"Purchasing Assets")];case 3:return c.sent(),[2]}}))}))},e.prototype.getQuoteFromUniswap=function(e){var t=e.numTokens,r=e.isBuying,n=e.contractAddress;return o(this,void 0,void 0,(function(){var e,o,d,h,m,y,A;return c(this,(function(c){switch(c.label){case 0:return[4,this.web3.eth.contract(v.WrappedNFTFactory).at(this._wrappedNFTFactoryAddress)];case 1:return[4,c.sent().nftContractToWrapperContract(n)];case 2:return e=c.sent(),[4,this.web3.eth.contract(v.WrappedNFT).at(e)];case 3:return o=c.sent(),[4,this.web3.eth.contract(v.UniswapFactory).at(this._uniswapFactoryAddress)];case 4:return[4,c.sent().getExchange(e)];case 5:return d=c.sent(),[4,this.web3.eth.contract(v.UniswapExchange).at(d)];case 6:return h=c.sent(),m=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(t),o.decimals()),r?(y=parseInt,[4,h.getEthToTokenOutputPrice(m)]):[3,8];case 7:return[2,y.apply(void 0,[c.sent()])];case 8:return A=parseInt,[4,h.getTokenToEthInputPrice(m)];case 9:return[2,A.apply(void 0,[c.sent()])]}}))}))},e.prototype.wrapEth=function(e){var t=e.amountInEth,r=e.accountAddress;return o(this,void 0,void 0,(function(){var e,n,o,d,m=this;return c(this,(function(c){switch(c.label){case 0:return e=h.tokens[this._networkName].canonicalWrappedEther,n=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(t),e.decimals),this._dispatch(A.EventType.WrapEth,{accountAddress:r,amount:n}),[4,this._computeGasPrice()];case 1:return o=c.sent(),[4,f.sendRawTransaction(this.web3,{from:r,to:e.address,value:n,data:_.encodeCall(v.getMethod(v.CanonicalWETH,"deposit"),[]),gasPrice:o},(function(e){m._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:r})}))];case 2:return d=c.sent(),[4,this._confirmTransaction(d,A.EventType.WrapEth,"Wrapping ETH")];case 3:return c.sent(),[2]}}))}))},e.prototype.unwrapWeth=function(e){var t=e.amountInEth,r=e.accountAddress;return o(this,void 0,void 0,(function(){var e,n,o,d,m=this;return c(this,(function(c){switch(c.label){case 0:return e=h.tokens[this._networkName].canonicalWrappedEther,n=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(t),e.decimals),this._dispatch(A.EventType.UnwrapWeth,{accountAddress:r,amount:n}),[4,this._computeGasPrice()];case 1:return o=c.sent(),[4,f.sendRawTransaction(this.web3,{from:r,to:e.address,value:0,data:_.encodeCall(v.getMethod(v.CanonicalWETH,"withdraw"),[n.toString()]),gasPrice:o},(function(e){m._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:r})}))];case 2:return d=c.sent(),[4,this._confirmTransaction(d,A.EventType.UnwrapWeth,"Unwrapping W-ETH")];case 3:return c.sent(),[2]}}))}))},e.prototype.createBundleBuyOrder=function(e){var t=e.assets,r=e.collection,d=e.quantities,l=e.accountAddress,m=e.startAmount,y=e.expirationTime,v=void 0===y?0:y,A=e.paymentTokenAddress,_=e.sellOrder,w=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,o,y,T,k;return c(this,(function(c){switch(c.label){case 0:return d=d||t.map((function(a){return 1})),A=A||h.tokens[this._networkName].canonicalWrappedEther.address,[4,this._makeBundleBuyOrder({assets:t,collection:r,quantities:d,accountAddress:l,startAmount:m,expirationTime:v,paymentTokenAddress:A,extraBountyBasisPoints:0,sellOrder:_,referrerAddress:w})];case 1:return e=c.sent(),[4,this._buyOrderValidationAndApprovals({order:e,accountAddress:l})];case 2:c.sent(),o=n({},e,{hash:f.getOrderHash(e)}),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this._authorizeOrder(o)];case 4:return y=c.sent(),[3,6];case 5:throw T=c.sent(),console.error(T),new Error("You declined to authorize your offer");case 6:return k=n({},o,y),[2,this.validateAndPostOrder(k)]}}))}))},e.prototype.createBuyOrder=function(e){var t=e.asset,r=e.accountAddress,d=e.startAmount,l=e.quantity,m=void 0===l?1:l,y=e.expirationTime,v=void 0===y?0:y,A=e.paymentTokenAddress,_=e.sellOrder,w=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,o,l,y,T;return c(this,(function(c){switch(c.label){case 0:return A=A||h.tokens[this._networkName].canonicalWrappedEther.address,[4,this._makeBuyOrder({asset:t,quantity:m,accountAddress:r,startAmount:d,expirationTime:v,paymentTokenAddress:A,extraBountyBasisPoints:0,sellOrder:_,referrerAddress:w})];case 1:return e=c.sent(),[4,this._buyOrderValidationAndApprovals({order:e,accountAddress:r})];case 2:c.sent(),o=n({},e,{hash:f.getOrderHash(e)}),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this._authorizeOrder(o)];case 4:return l=c.sent(),[3,6];case 5:throw y=c.sent(),console.error(y),new Error("You declined to authorize your offer");case 6:return T=n({},o,l),[2,this.validateAndPostOrder(T)]}}))}))},e.prototype.createSellOrder=function(e){var t=e.asset,r=e.accountAddress,d=e.startAmount,l=e.endAmount,h=e.quantity,m=void 0===h?1:h,y=e.listingTime,v=e.expirationTime,A=void 0===v?0:v,_=e.waitForHighestBid,w=void 0!==_&&_,T=e.englishAuctionReservePrice,k=e.paymentTokenAddress,P=e.extraBountyBasisPoints,S=void 0===P?0:P,N=e.buyerAddress,F=e.buyerEmail;return o(this,void 0,void 0,(function(){var e,o,h,v,_;return c(this,(function(c){switch(c.label){case 0:return[4,this._makeSellOrder({asset:t,quantity:m,accountAddress:r,startAmount:d,endAmount:l,listingTime:y,expirationTime:A,waitForHighestBid:w,englishAuctionReservePrice:T,paymentTokenAddress:k||E.NULL_ADDRESS,extraBountyBasisPoints:S,buyerAddress:N||E.NULL_ADDRESS})];case 1:return e=c.sent(),[4,this._sellOrderValidationAndApprovals({order:e,accountAddress:r})];case 2:return c.sent(),F?[4,this._createEmailWhitelistEntry({order:e,buyerEmail:F})]:[3,4];case 3:c.sent(),c.label=4;case 4:o=n({},e,{hash:f.getOrderHash(e)}),c.label=5;case 5:return c.trys.push([5,7,,8]),[4,this._authorizeOrder(o)];case 6:return h=c.sent(),[3,8];case 7:throw v=c.sent(),console.error(v),new Error("You declined to authorize your auction");case 8:return _=n({},o,h),[2,this.validateAndPostOrder(_)]}}))}))},e.prototype.createFactorySellOrders=function(e){var t=e.assets,r=e.accountAddress,d=e.startAmount,l=e.endAmount,h=e.quantity,y=void 0===h?1:h,v=e.listingTime,A=e.expirationTime,_=void 0===A?0:A,w=e.waitForHighestBid,T=void 0!==w&&w,k=e.paymentTokenAddress,P=e.extraBountyBasisPoints,S=void 0===P?0:P,N=e.buyerAddress,F=e.buyerEmail,R=e.numberOfOrders,B=void 0===R?1:R;return o(this,void 0,void 0,(function(){var e,h,A,w,P,R,x,C,O,L=this;return c(this,(function(D){switch(D.label){case 0:if(B<1)throw new Error("Need to make at least one sell order");if(!t||!t.length)throw new Error("Need at least one asset to create orders for");if(1!==m.uniqBy(t,(function(a){return a.tokenAddress})).length)throw new Error("All assets must be on the same factory contract address");return[4,this._makeSellOrder({asset:t[0],quantity:y,accountAddress:r,startAmount:d,endAmount:l,listingTime:v,expirationTime:_,waitForHighestBid:T,paymentTokenAddress:k||E.NULL_ADDRESS,extraBountyBasisPoints:S,buyerAddress:N||E.NULL_ADDRESS})];case 1:return e=D.sent(),[4,this._sellOrderValidationAndApprovals({order:e,accountAddress:r})];case 2:D.sent(),h=function(e){return o(L,void 0,void 0,(function(){var t,o,h,m,A;return c(this,(function(c){switch(c.label){case 0:return[4,this._makeSellOrder({asset:e,quantity:y,accountAddress:r,startAmount:d,endAmount:l,listingTime:v,expirationTime:_,waitForHighestBid:T,paymentTokenAddress:k||E.NULL_ADDRESS,extraBountyBasisPoints:S,buyerAddress:N||E.NULL_ADDRESS})];case 1:return t=c.sent(),F?[4,this._createEmailWhitelistEntry({order:t,buyerEmail:F})]:[3,3];case 2:c.sent(),c.label=3;case 3:o=n({},t,{hash:f.getOrderHash(t)}),c.label=4;case 4:return c.trys.push([4,6,,7]),[4,this._authorizeOrder(o)];case 5:return h=c.sent(),[3,7];case 6:throw m=c.sent(),console.error(m),new Error("You declined to authorize your auction, or your web3 provider can't sign using personal_sign. Try 'web3-provider-engine' and make sure a mnemonic is set. Just a reminder: there's no gas needed anymore to mint tokens!");case 7:return A=n({},o,h),[2,this.validateAndPostOrder(A)]}}))}))},A=m.range(B*t.length),w=m.chunk(A,E.SELL_ORDER_BATCH_SIZE),P=0,R=0,x=w,D.label=3;case 3:return R<x.length?(C=x[R],[4,Promise.all(C.map((function(e){return o(L,void 0,void 0,(function(){var r;return c(this,(function(n){return r=Math.floor(e/B),[2,h(t[r])]}))}))})))]):[3,7];case 4:return O=D.sent(),this.logger("Created and posted a batch of "+O.length+" orders in parallel."),P+=O.length,[4,f.delay(500)];case 5:D.sent(),D.label=6;case 6:return R++,[3,3];case 7:return[2,P]}}))}))},e.prototype.createBundleSellOrder=function(e){var t=e.bundleName,r=e.bundleDescription,d=e.bundleExternalLink,l=e.assets,h=e.collection,m=e.quantities,y=e.accountAddress,v=e.startAmount,A=e.endAmount,_=e.expirationTime,w=void 0===_?0:_,T=e.listingTime,k=e.waitForHighestBid,P=void 0!==k&&k,S=e.englishAuctionReservePrice,N=e.paymentTokenAddress,F=e.extraBountyBasisPoints,R=void 0===F?0:F,B=e.buyerAddress;return o(this,void 0,void 0,(function(){var e,o,_,k,F;return c(this,(function(c){switch(c.label){case 0:return m=m||l.map((function(a){return 1})),[4,this._makeBundleSellOrder({bundleName:t,bundleDescription:r,bundleExternalLink:d,assets:l,collection:h,quantities:m,accountAddress:y,startAmount:v,endAmount:A,listingTime:T,expirationTime:w,waitForHighestBid:P,englishAuctionReservePrice:S,paymentTokenAddress:N||E.NULL_ADDRESS,extraBountyBasisPoints:R,buyerAddress:B||E.NULL_ADDRESS})];case 1:return e=c.sent(),[4,this._sellOrderValidationAndApprovals({order:e,accountAddress:y})];case 2:c.sent(),o=n({},e,{hash:f.getOrderHash(e)}),c.label=3;case 3:return c.trys.push([3,5,,6]),[4,this._authorizeOrder(o)];case 4:return _=c.sent(),[3,6];case 5:throw k=c.sent(),console.error(k),new Error("You declined to authorize your auction");case 6:return F=n({},o,_),[2,this.validateAndPostOrder(F)]}}))}))},e.prototype.fulfillOrder=function(e){var t=e.order,r=e.accountAddress,n=e.recipientAddress,d=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,l,h,m,y,v,_=this;return c(this,(function(w){switch(w.label){case 0:return e=this._makeMatchingOrder({order:t,accountAddress:r,recipientAddress:n||r}),l=f.assignOrdersToSides(t,e),h=l.buy,m=l.sell,y=this._getMetadata(t,d),[4,this._atomicMatch({buy:h,sell:m,accountAddress:r,metadata:y})];case 1:return v=w.sent(),[4,this._confirmTransaction(v,A.EventType.MatchOrders,"Fulfilling order",(function(){return o(_,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this._validateOrder(t)];case 1:return[2,!e.sent()]}}))}))}))];case 2:return w.sent(),[2,v]}}))}))},e.prototype.cancelOrder=function(e){var t=e.order,r=e.accountAddress;return o(this,void 0,void 0,(function(){var e,n,d=this;return c(this,(function(l){switch(l.label){case 0:return this._dispatch(A.EventType.CancelOrder,{order:t,accountAddress:r}),[4,this._computeGasPrice()];case 1:return e=l.sent(),[4,this._wyvernProtocol.wyvernExchange.cancelOrder_.sendTransactionAsync([t.exchange,t.maker,t.taker,t.feeRecipient,t.target,t.staticTarget,t.paymentToken],[t.makerRelayerFee,t.takerRelayerFee,t.makerProtocolFee,t.takerProtocolFee,t.basePrice,t.extra,t.listingTime,t.expirationTime,t.salt],t.feeMethod,t.side,t.saleKind,t.howToCall,t.calldata,t.replacementPattern,t.staticExtradata,t.v||0,t.r||E.NULL_BLOCK_HASH,t.s||E.NULL_BLOCK_HASH,{from:r,gasPrice:e})];case 2:return n=l.sent(),[4,this._confirmTransaction(n.toString(),A.EventType.CancelOrder,"Cancelling order",(function(){return o(d,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this._validateOrder(t)];case 1:return[2,!e.sent()]}}))}))}))];case 3:return l.sent(),[2]}}))}))},e.prototype.approveSemiOrNonFungibleToken=function(e){var t=e.tokenId,r=e.tokenAddress,n=e.accountAddress,d=e.proxyAddress,l=e.tokenAbi,h=void 0===l?v.ERC721:l,m=e.skipApproveAllIfTokenAddressIn,y=void 0===m?new Set:m,_=e.schemaName,w=void 0===_?A.WyvernSchemaName.ERC721:_;return o(this,void 0,void 0,(function(){var e,l,m,v,_,T,k,P,E,S=this;return c(this,(function(N){switch(N.label){case 0:return e=this._getSchema(w),[4,this.web3.eth.contract(h).at(r)];case 1:return l=N.sent(),d?[3,3]:[4,this._getProxy(n)];case 2:if(!(d=N.sent()||void 0))throw new Error("Uninitialized account");N.label=3;case 3:return[4,(m=function(){return o(S,void 0,void 0,(function(){var e;return c(this,(function(t){switch(t.label){case 0:return[4,f.rawCall(this.web3ReadOnly,{from:n,to:l.address,data:l.isApprovedForAll.getData(n,d)})];case 1:return e=t.sent(),[2,parseInt(e)]}}))}))})()];case 4:if(1==(v=N.sent()))return this.logger("Already approved proxy for all tokens"),[2,null];if(0!=v)return[3,10];if(y.has(r))return this.logger("Already approving proxy for all tokens in another transaction"),[2,null];y.add(r),N.label=5;case 5:return N.trys.push([5,9,,10]),this._dispatch(A.EventType.ApproveAllAssets,{accountAddress:n,proxyAddress:d,contractAddress:r}),[4,this._computeGasPrice()];case 6:return k=N.sent(),[4,f.sendRawTransaction(this.web3,{from:n,to:l.address,data:l.setApprovalForAll.getData(d,!0),gasPrice:k},(function(e){S._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:n})}))];case 7:return P=N.sent(),[4,this._confirmTransaction(P,A.EventType.ApproveAllAssets,"Approving all tokens of this type for trading",(function(){return o(S,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,m()];case 1:return[2,1==e.sent()]}}))}))}))];case 8:return N.sent(),[2,P];case 9:throw _=N.sent(),console.error(_),new Error("Couldn't get permission to approve these tokens for trading. Their contract might not be implemented correctly. Please contact the developer!");case 10:return this.logger("Contract does not support Approve All"),[4,(T=function(){return o(S,void 0,void 0,(function(){var e;return c(this,(function(r){switch(r.label){case 0:return[4,f.promisifyCall((function(e){return l.getApproved.call(t,e)}))];case 1:return(e=r.sent())==d?(this.logger("Already approved proxy for this token"),[2,!0]):(this.logger("Approve response: "+e),e?[3,3]:[4,f.getNonCompliantApprovalAddress(l,t,n)]);case 2:if((e=r.sent())==d)return this.logger("Already approved proxy for this item"),[2,!0];this.logger("Special-case approve response: "+e),r.label=3;case 3:return[2,!1]}}))}))})()];case 11:if(N.sent())return[2,null];N.label=12;case 12:return N.trys.push([12,16,,17]),this._dispatch(A.EventType.ApproveAsset,{accountAddress:n,proxyAddress:d,asset:f.getWyvernAsset(e,{tokenId:t,tokenAddress:r})}),[4,this._computeGasPrice()];case 13:return k=N.sent(),[4,f.sendRawTransaction(this.web3,{from:n,to:l.address,data:l.approve.getData(d,t),gasPrice:k},(function(e){S._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:n})}))];case 14:return P=N.sent(),[4,this._confirmTransaction(P,A.EventType.ApproveAsset,"Approving single token for trading",T)];case 15:return N.sent(),[2,P];case 16:throw E=N.sent(),console.error(E),new Error("Couldn't get permission to approve this token for trading. Its contract might not be implemented correctly. Please contact the developer!");case 17:return[2]}}))}))},e.prototype.approveFungibleToken=function(e){var t=e.accountAddress,r=e.tokenAddress,n=e.proxyAddress,d=e.minimumAmount,h=void 0===d?l.WyvernProtocol.MAX_UINT_256:d;return o(this,void 0,void 0,(function(){var e,d,m,y,w=this;return c(this,(function(T){switch(T.label){case 0:return n=n||l.WyvernProtocol.getTokenTransferProxyAddress(this._networkName),[4,this._getApprovedTokenCount({accountAddress:t,tokenAddress:r,proxyAddress:n})];case 1:return(e=T.sent()).greaterThanOrEqualTo(h)?(this.logger("Already approved enough currency for trading"),[2,null]):(this.logger("Not enough token approved for trade: "+e+" approved to transfer "+r),this._dispatch(A.EventType.ApproveCurrency,{accountAddress:t,contractAddress:r,proxyAddress:n}),d=[E.ENJIN_COIN_ADDRESS,E.MANA_ADDRESS].includes(r.toLowerCase()),h.greaterThan(0)&&d?[4,this.unapproveFungibleToken({accountAddress:t,tokenAddress:r,proxyAddress:n})]:[3,3]);case 2:T.sent(),T.label=3;case 3:return[4,this._computeGasPrice()];case 4:return m=T.sent(),[4,f.sendRawTransaction(this.web3,{from:t,to:r,data:_.encodeCall(v.getMethod(v.ERC20,"approve"),[n,l.WyvernProtocol.MAX_UINT_256.toString()]),gasPrice:m},(function(e){w._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:t})}))];case 5:return y=T.sent(),[4,this._confirmTransaction(y,A.EventType.ApproveCurrency,"Approving currency for trading",(function(){return o(w,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this._getApprovedTokenCount({accountAddress:t,tokenAddress:r,proxyAddress:n})];case 1:return[2,e.sent().greaterThanOrEqualTo(h)]}}))}))}))];case 6:return T.sent(),[2,y]}}))}))},e.prototype.unapproveFungibleToken=function(e){var t=e.accountAddress,r=e.tokenAddress,n=e.proxyAddress;return o(this,void 0,void 0,(function(){var e,d,h=this;return c(this,(function(m){switch(m.label){case 0:return n=n||l.WyvernProtocol.getTokenTransferProxyAddress(this._networkName),[4,this._computeGasPrice()];case 1:return e=m.sent(),[4,f.sendRawTransaction(this.web3,{from:t,to:r,data:_.encodeCall(v.getMethod(v.ERC20,"approve"),[n,0]),gasPrice:e},(function(e){h._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:t})}))];case 2:return d=m.sent(),[4,this._confirmTransaction(d,A.EventType.UnapproveCurrency,"Resetting Currency Approval",(function(){return o(h,void 0,void 0,(function(){return c(this,(function(e){switch(e.label){case 0:return[4,this._getApprovedTokenCount({accountAddress:t,tokenAddress:r,proxyAddress:n})];case 1:return[2,e.sent().isZero()]}}))}))}))];case 3:return m.sent(),[2,d]}}))}))},e.prototype.getCurrentPrice=function(e){return o(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this._wyvernProtocolReadOnly.wyvernExchange.calculateCurrentPrice_.callAsync([e.exchange,e.maker,e.taker,e.feeRecipient,e.target,e.staticTarget,e.paymentToken],[e.makerRelayerFee,e.takerRelayerFee,e.makerProtocolFee,e.takerProtocolFee,e.basePrice,e.extra,e.listingTime,e.expirationTime,e.salt],e.feeMethod,e.side,e.saleKind,e.howToCall,e.calldata,e.replacementPattern,e.staticExtradata)];case 1:return[2,t.sent()]}}))}))},e.prototype.isOrderFulfillable=function(e){var t=e.order,r=e.accountAddress,n=e.recipientAddress,d=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,o,l,h,m,y;return c(this,(function(c){switch(c.label){case 0:return e=this._makeMatchingOrder({order:t,accountAddress:r,recipientAddress:n||r}),o=f.assignOrdersToSides(t,e),l=o.buy,h=o.sell,m=this._getMetadata(t,d),[4,this._estimateGasForMatch({buy:l,sell:h,accountAddress:r,metadata:m})];case 1:return y=c.sent(),this.logger("Gas estimate for "+(t.side==A.OrderSide.Sell?"sell":"buy")+" order: "+y),[2,null!=y&&y>0]}}))}))},e.prototype.isAssetTransferrable=function(e,t){var r=e.asset,n=e.fromAddress,d=e.toAddress,h=e.quantity,m=e.useProxy,y=void 0!==m&&m;return void 0===t&&(t=1),o(this,void 0,void 0,(function(){var e,o,m,v,A,w,data,T;return c(this,(function(c){switch(c.label){case 0:return e=this._getSchema(r.schemaName),o=h?l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(h),r.decimals||0):f.makeBigNumber(1),m=f.getWyvernAsset(e,r,o),v=e.functions.transfer(m),A=n,y?[4,this._getProxy(n)]:[3,2];case 1:if(!(w=c.sent()))return console.error("This asset's owner ("+n+") does not have a proxy!"),[2,!1];A=w,c.label=2;case 2:data=_.encodeTransferCall(v,n,d),c.label=3;case 3:return c.trys.push([3,5,,8]),[4,f.estimateGas(this._getClientsForRead(t).web3,{from:A,to:v.target,data:data})];case 4:return[2,c.sent()>0];case 5:return T=c.sent(),t<=0?(console.error(T),console.error(A,v.target,data),[2,!1]):[4,f.delay(500)];case 6:return c.sent(),[4,this.isAssetTransferrable({asset:r,fromAddress:n,toAddress:d,quantity:h,useProxy:y},t-1)];case 7:return[2,c.sent()];case 8:return[2]}}))}))},e.prototype.transfer=function(e){var t=e.fromAddress,r=e.toAddress,n=e.asset,d=e.quantity,h=void 0===d?1:d;return o(this,void 0,void 0,(function(){var e,o,d,m,y,v,w,data,T,k=this;return c(this,(function(c){switch(c.label){case 0:return e=this._getSchema(n.schemaName),o=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(h),n.decimals||0),d=f.getWyvernAsset(e,n,o),m=[E.CK_ADDRESS,E.CK_RINKEBY_ADDRESS].includes(d.address),y=m||!!n.version&&[A.TokenStandardVersion.ERC721v1,A.TokenStandardVersion.ERC721v2].includes(n.version),v=n.schemaName===A.WyvernSchemaName.ERC20?f.annotateERC20TransferABI(d):y?f.annotateERC721TransferABI(d):e.functions.transfer(d),this._dispatch(A.EventType.TransferOne,{accountAddress:t,toAddress:r,asset:d}),[4,this._computeGasPrice()];case 1:return w=c.sent(),data=_.encodeTransferCall(v,t,r),[4,f.sendRawTransaction(this.web3,{from:t,to:v.target,data:data,gasPrice:w},(function(e){k._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:t})}))];case 2:return T=c.sent(),[4,this._confirmTransaction(T,A.EventType.TransferOne,"Transferring asset")];case 3:return c.sent(),[2,T]}}))}))},e.prototype.transferAll=function(e){var t=e.assets,r=e.fromAddress,n=e.toAddress,d=e.schemaName,l=void 0===d?A.WyvernSchemaName.ERC721:d;return o(this,void 0,void 0,(function(){var e,o,d,h,m,y,v,w,T=this;return c(this,(function(c){switch(c.label){case 0:return n=f.validateAndFormatWalletAddress(this.web3,n),e=t.map((function(e){return e.schemaName||l})),o=t.map((function(e){return f.getWyvernAsset(T._getSchema(e.schemaName),e)})),d=_.encodeAtomicizedTransfer(e.map((function(e){return T._getSchema(e)})),o,r,n,this._wyvernProtocol,this._networkName),h=d.calldata,m=d.target,[4,this._getProxy(r)];case 1:return(y=c.sent())?[3,3]:[4,this._initializeProxy(r)];case 2:y=c.sent(),c.label=3;case 3:return[4,this._approveAll({schemaNames:e,wyAssets:o,accountAddress:r,proxyAddress:y})];case 4:return c.sent(),this._dispatch(A.EventType.TransferAll,{accountAddress:r,toAddress:n,assets:o}),[4,this._computeGasPrice()];case 5:return v=c.sent(),[4,f.sendRawTransaction(this.web3,{from:r,to:y,data:_.encodeProxyCall(m,A.HowToCall.DelegateCall,h),gasPrice:v},(function(e){T._dispatch(A.EventType.TransactionDenied,{error:e,accountAddress:r})}))];case 6:return w=c.sent(),[4,this._confirmTransaction(w,A.EventType.TransferAll,"Transferring "+t.length+" asset"+(1==t.length?"":"s"))];case 7:return c.sent(),[2,w]}}))}))},e.prototype.getFungibleTokens=function(e){var t=void 0===e?{}:e,symbol=t.symbol,address=t.address,r=t.name;return o(this,void 0,void 0,(function(){var e,t;return c(this,(function(n){switch(n.label){case 0:return f.onDeprecated("Use `api.getPaymentTokens` instead"),e=h.tokens[this._networkName],[4,this.api.getPaymentTokens({symbol:symbol,address:address,name:r})];case 1:return t=n.sent().tokens,[2,[e.canonicalWrappedEther].concat(e.otherTokens).filter((function(e){return(null==symbol||e.symbol.toLowerCase()==symbol.toLowerCase())&&((null==address||e.address.toLowerCase()==address.toLowerCase())&&(null==r||e.name==r))})).concat(t)]}}))}))},e.prototype.getAssetBalance=function(e,t){var r=e.accountAddress,n=e.asset;return void 0===t&&(t=1),o(this,void 0,void 0,(function(){var e,o,d,l,h,m,y,v,A,_;return c(this,(function(c){switch(c.label){case 0:return e=this._getSchema(n.schemaName),o=f.getWyvernAsset(e,n),e.functions.countOf?(d=e.functions.countOf(o),l=this._getClientsForRead(t).web3.eth.contract([d]).at(d.target),h=d.inputs.filter((function(e){return void 0!==e.value})).map((function(e){return e.value})),[4,f.promisifyCall((function(e){var t;return(t=l[d.name]).call.apply(t,[r].concat(h,[e]))}))]):[3,2];case 1:return void 0!==(m=c.sent())?[2,m]:[3,5];case 2:if(!e.functions.ownerOf)return[3,4];if(y=e.functions.ownerOf(o),v=this._getClientsForRead(t).web3.eth.contract([y]).at(y.target),y.inputs.filter((function(e){return void 0===e.value}))[0])throw new Error("Missing an argument for finding the owner of this asset");return A=y.inputs.map((function(i){return i.value.toString()})),[4,f.promisifyCall((function(e){var t;return(t=v[y.name]).call.apply(t,A.concat([e]))}))];case 3:return(_=c.sent())?[2,_.toLowerCase()==r.toLowerCase()?new T.BigNumber(1):new T.BigNumber(0)]:[3,5];case 4:throw new Error("Missing ownership schema for this asset type");case 5:if(!(t<=0))return[3,6];throw new Error("Unable to get current owner from smart contract");case 6:return[4,f.delay(500)];case 7:return c.sent(),[4,this.getAssetBalance({accountAddress:r,asset:n},t-1)];case 8:return[2,c.sent()]}}))}))},e.prototype.getTokenBalance=function(e,t){var r=e.accountAddress,n=e.tokenAddress,d=e.schemaName,l=void 0===d?A.WyvernSchemaName.ERC20:d;return void 0===t&&(t=1),o(this,void 0,void 0,(function(){var e;return c(this,(function(o){return e={tokenId:null,tokenAddress:n,schemaName:l},[2,this.getAssetBalance({accountAddress:r,asset:e},t)]}))}))},e.prototype.computeFees=function(e){var t=e.asset,r=e.side,n=e.accountAddress,d=e.isPrivate,l=void 0!==d&&d,h=e.extraBountyBasisPoints,m=void 0===h?0:h;return o(this,void 0,void 0,(function(){var e,o,d,h,y,v,_,w,T,k,P,S;return c(this,(function(c){switch(c.label){case 0:if(e=E.DEFAULT_BUYER_FEE_BASIS_POINTS,o=E.DEFAULT_SELLER_FEE_BASIS_POINTS,d=0,h=0,y=f.makeBigNumber(0),v=null,_=E.DEFAULT_MAX_BOUNTY,t&&(e=+t.collection.openseaBuyerFeeBasisPoints,o=+t.collection.openseaSellerFeeBasisPoints,d=+t.collection.devBuyerFeeBasisPoints,h=+t.collection.devSellerFeeBasisPoints,_=o),r!=A.OrderSide.Sell||!t)return[3,4];y=t.transferFee?f.makeBigNumber(t.transferFee):y,v=t.transferFeePaymentToken?t.transferFeePaymentToken.address:v,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,f.getTransferFeeSettings(this.web3,{asset:t,accountAddress:n})];case 2:return w=c.sent(),y=null!=w.transferFee?w.transferFee:y,v=w.transferFeeTokenAddress||v,[3,4];case 3:return T=c.sent(),console.error(T),[3,4];case 4:if(k=r==A.OrderSide.Sell?m:0,P=k+E.OPENSEA_SELLER_BOUNTY_BASIS_POINTS>_,k>0&&P)throw S="Total bounty exceeds the maximum for this asset type ("+_/100+"%).",_>=E.OPENSEA_SELLER_BOUNTY_BASIS_POINTS&&(S+=" Remember that OpenSea will add "+E.OPENSEA_SELLER_BOUNTY_BASIS_POINTS/100+"% for referrers with OpenSea accounts!"),new Error(S);return l&&(e=0,o=0,d=0,h=0,k=0),[2,{totalBuyerFeeBasisPoints:e+d,totalSellerFeeBasisPoints:o+h,openseaBuyerFeeBasisPoints:e,openseaSellerFeeBasisPoints:o,devBuyerFeeBasisPoints:d,devSellerFeeBasisPoints:h,sellerBountyBasisPoints:k,transferFee:y,transferFeeTokenAddress:v}]}}))}))},e.prototype.validateAndPostOrder=function(e){return o(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this._wyvernProtocolReadOnly.wyvernExchange.hashOrder_.callAsync([e.exchange,e.maker,e.taker,e.feeRecipient,e.target,e.staticTarget,e.paymentToken],[e.makerRelayerFee,e.takerRelayerFee,e.makerProtocolFee,e.takerProtocolFee,e.basePrice,e.extra,e.listingTime,e.expirationTime,e.salt],e.feeMethod,e.side,e.saleKind,e.howToCall,e.calldata,e.replacementPattern,e.staticExtradata)];case 1:if(t.sent()!==e.hash)throw console.error(e),new Error("Order couldn't be validated by the exchange due to a hash mismatch. Make sure your wallet is on the right network!");return this.logger("Order hashes match"),[4,this.api.postOrder(f.orderToJSON(e))];case 2:return[2,t.sent()]}}))}))},e.prototype._computeGasPrice=function(){return o(this,void 0,void 0,(function(){var e,t;return c(this,(function(r){switch(r.label){case 0:return[4,f.getCurrentGasPrice(this.web3)];case 1:return e=r.sent(),t=this.web3.toWei(this.gasPriceAddition,"gwei"),[2,e.plus(t)]}}))}))},e.prototype._correctGasAmount=function(e){return Math.ceil(e*this.gasIncreaseFactor)},e.prototype._estimateGasForMatch=function(e,t){var r=e.buy,n=e.sell,d=e.accountAddress,l=e.metadata,h=void 0===l?E.NULL_BLOCK_HASH:l;return void 0===t&&(t=1),o(this,void 0,void 0,(function(){var e,o;return c(this,(function(c){switch(c.label){case 0:return r.maker.toLowerCase()!=d.toLowerCase()||r.paymentToken!=E.NULL_ADDRESS?[3,2]:[4,this._getRequiredAmountForTakingSellOrder(n)];case 1:e=c.sent(),c.label=2;case 2:return c.trys.push([2,4,,7]),[4,this._getClientsForRead(t).wyvernProtocol.wyvernExchange.atomicMatch_.estimateGasAsync([r.exchange,r.maker,r.taker,r.feeRecipient,r.target,r.staticTarget,r.paymentToken,n.exchange,n.maker,n.taker,n.feeRecipient,n.target,n.staticTarget,n.paymentToken],[r.makerRelayerFee,r.takerRelayerFee,r.makerProtocolFee,r.takerProtocolFee,r.basePrice,r.extra,r.listingTime,r.expirationTime,r.salt,n.makerRelayerFee,n.takerRelayerFee,n.makerProtocolFee,n.takerProtocolFee,n.basePrice,n.extra,n.listingTime,n.expirationTime,n.salt],[r.feeMethod,r.side,r.saleKind,r.howToCall,n.feeMethod,n.side,n.saleKind,n.howToCall],r.calldata,n.calldata,r.replacementPattern,n.replacementPattern,r.staticExtradata,n.staticExtradata,[r.v||0,n.v||0],[r.r||E.NULL_BLOCK_HASH,r.s||E.NULL_BLOCK_HASH,n.r||E.NULL_BLOCK_HASH,n.s||E.NULL_BLOCK_HASH,h],{from:d,value:e})];case 3:return[2,c.sent()];case 4:return o=c.sent(),t<=0?(console.error(o),[2,void 0]):[4,f.delay(200)];case 5:return c.sent(),[4,this._estimateGasForMatch({buy:r,sell:n,accountAddress:d,metadata:h},t-1)];case 6:return[2,c.sent()];case 7:return[2]}}))}))},e.prototype._estimateGasForTransfer=function(e){var t=e.assets,r=e.fromAddress,n=e.toAddress,d=e.schemaName,l=void 0===d?A.WyvernSchemaName.ERC721:d;return o(this,void 0,void 0,(function(){var e,o,d,h,m,y,v=this;return c(this,(function(c){switch(c.label){case 0:return e=t.map((function(e){return e.schemaName||l})),o=t.map((function(e){return f.getWyvernAsset(v._getSchema(e.schemaName),e)})),[4,this._getProxy(r)];case 1:if(!(d=c.sent()))throw new Error("Uninitialized proxy address");return[4,this._approveAll({schemaNames:e,wyAssets:o,accountAddress:r,proxyAddress:d})];case 2:return c.sent(),h=_.encodeAtomicizedTransfer(e.map((function(e){return v._getSchema(e)})),o,r,n,this._wyvernProtocol,this._networkName),m=h.calldata,y=h.target,[2,f.estimateGas(this.web3,{from:r,to:d,data:_.encodeProxyCall(y,A.HowToCall.DelegateCall,m)})]}}))}))},e.prototype._getProxy=function(e,t){return void 0===t&&(t=0),o(this,void 0,void 0,(function(){var r;return c(this,(function(n){switch(n.label){case 0:return[4,this._wyvernProtocolReadOnly.wyvernProxyRegistry.proxies.callAsync(e)];case 1:if("0x"==(r=n.sent()))throw new Error("Couldn't retrieve your account from the blockchain - make sure you're on the correct Ethereum network!");return r&&r!=E.NULL_ADDRESS?[3,5]:t>0?[4,f.delay(1e3)]:[3,4];case 2:return n.sent(),[4,this._getProxy(e,t-1)];case 3:return[2,n.sent()];case 4:r=null,n.label=5;case 5:return[2,r]}}))}))},e.prototype._initializeProxy=function(e){return o(this,void 0,void 0,(function(){var t,r,d,l,h,m=this;return c(this,(function(y){switch(y.label){case 0:return this._dispatch(A.EventType.InitializeAccount,{accountAddress:e}),this.logger("Initializing proxy for account: "+e),[4,this._computeGasPrice()];case 1:return t=y.sent(),r={from:e},[4,this._wyvernProtocolReadOnly.wyvernProxyRegistry.registerProxy.estimateGasAsync(r)];case 2:return d=y.sent(),[4,this._wyvernProtocol.wyvernProxyRegistry.registerProxy.sendTransactionAsync(n({},r,{gasPrice:t,gas:this._correctGasAmount(d)}))];case 3:return l=y.sent(),[4,this._confirmTransaction(l,A.EventType.InitializeAccount,"Initializing proxy for account",(function(){return o(m,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this._getProxy(e)];case 1:return[2,!!t.sent()]}}))}))}))];case 4:return y.sent(),[4,this._getProxy(e,2)];case 5:if(!(h=y.sent()))throw new Error("Failed to initialize your account :( Please restart your wallet/browser and try again!");return[2,h]}}))}))},e.prototype._getApprovedTokenCount=function(e){var t=e.accountAddress,r=e.tokenAddress,n=e.proxyAddress;return o(this,void 0,void 0,(function(){var e,o;return c(this,(function(c){switch(c.label){case 0:return r||(r=h.tokens[this._networkName].canonicalWrappedEther.address),e=n||l.WyvernProtocol.getTokenTransferProxyAddress(this._networkName),[4,f.rawCall(this.web3,{from:t,to:r,data:_.encodeCall(v.getMethod(v.ERC20,"allowance"),[t,e])})];case 1:return o=c.sent(),[2,f.makeBigNumber(o)]}}))}))},e.prototype._makeBuyOrder=function(e){var t=e.asset,r=e.quantity,n=e.accountAddress,d=e.startAmount,h=e.expirationTime,m=void 0===h?0:h,y=e.paymentTokenAddress,v=e.extraBountyBasisPoints,w=void 0===v?0:v,T=e.sellOrder,k=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,o,h,v,P,S,N,F,R,B,x,C,O,L,D,I,W,M,U,H,K,G,z,Y,V,Z,X,j;return c(this,(function(c){switch(c.label){case 0:return n=f.validateAndFormatWalletAddress(this.web3,n),e=this._getSchema(t.schemaName),o=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(r),t.decimals||0),h=f.getWyvernAsset(e,t,o),[4,this.api.getAsset(t)];case 1:return v=c.sent(),P=T?T.maker:E.NULL_ADDRESS,[4,this.computeFees({asset:v,extraBountyBasisPoints:w,side:A.OrderSide.Buy})];case 2:return S=c.sent(),N=S.totalBuyerFeeBasisPoints,F=S.totalSellerFeeBasisPoints,R=this._getBuyFeeParameters(N,F,T),B=R.makerRelayerFee,x=R.takerRelayerFee,C=R.makerProtocolFee,O=R.takerProtocolFee,L=R.makerReferrerFee,D=R.feeRecipient,I=R.feeMethod,W=_.encodeBuy(e,h,n),M=W.target,U=W.calldata,H=W.replacementPattern,[4,this._getPriceParameters(A.OrderSide.Buy,y,m,d)];case 3:return K=c.sent(),G=K.basePrice,z=K.extra,Y=K.paymentToken,V=this._getTimeParameters(m),[4,this._getStaticCallTargetAndExtraData({asset:v,useTxnOriginStaticCall:!1})];case 4:return Z=c.sent(),X=Z.staticTarget,j=Z.staticExtradata,[2,{exchange:l.WyvernProtocol.getExchangeContractAddress(this._networkName),maker:n,taker:P,quantity:o,makerRelayerFee:B,takerRelayerFee:x,makerProtocolFee:C,takerProtocolFee:O,makerReferrerFee:L,waitingForBestCounterOrder:!1,feeMethod:I,feeRecipient:D,side:A.OrderSide.Buy,saleKind:A.SaleKind.FixedPrice,target:M,howToCall:A.HowToCall.Call,calldata:U,replacementPattern:H,staticTarget:X,staticExtradata:j,paymentToken:Y,basePrice:G,extra:z,listingTime:V.listingTime,expirationTime:V.expirationTime,salt:l.WyvernProtocol.generatePseudoRandomSalt(),metadata:{asset:h,schema:e.name,referrerAddress:k}}]}}))}))},e.prototype._makeSellOrder=function(e){var t=e.asset,r=e.quantity,n=e.accountAddress,d=e.startAmount,h=e.endAmount,m=e.listingTime,y=e.expirationTime,v=e.waitForHighestBid,w=e.englishAuctionReservePrice,T=void 0===w?0:w,k=e.paymentTokenAddress,P=e.extraBountyBasisPoints,S=e.buyerAddress;return o(this,void 0,void 0,(function(){var e,o,w,N,F,R,B,x,C,O,L,D,I,W,M,U,H,K,G,z,Y,V,Z,X,j,J,Q,$,ee,te,re;return c(this,(function(c){switch(c.label){case 0:return n=f.validateAndFormatWalletAddress(this.web3,n),e=this._getSchema(t.schemaName),o=l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(r),t.decimals||0),w=f.getWyvernAsset(e,t,o),N=S!=E.NULL_ADDRESS,[4,this.api.getAsset(t)];case 1:return F=c.sent(),[4,this.computeFees({asset:F,side:A.OrderSide.Sell,isPrivate:N,extraBountyBasisPoints:P})];case 2:return R=c.sent(),B=R.totalSellerFeeBasisPoints,x=R.totalBuyerFeeBasisPoints,C=R.sellerBountyBasisPoints,O=_.encodeSell(e,w,n),L=O.target,D=O.calldata,I=O.replacementPattern,W=null!=h&&h!==d?A.SaleKind.DutchAuction:A.SaleKind.FixedPrice,[4,this._getPriceParameters(A.OrderSide.Sell,k,y,d,h,v,T)];case 3:return M=c.sent(),U=M.basePrice,H=M.extra,K=M.paymentToken,G=M.reservePrice,z=this._getTimeParameters(y,m,v),Y=this._getSellFeeParameters(x,B,v,C),V=Y.makerRelayerFee,Z=Y.takerRelayerFee,X=Y.makerProtocolFee,j=Y.takerProtocolFee,J=Y.makerReferrerFee,Q=Y.feeRecipient,$=Y.feeMethod,[4,this._getStaticCallTargetAndExtraData({asset:F,useTxnOriginStaticCall:v})];case 4:return ee=c.sent(),te=ee.staticTarget,re=ee.staticExtradata,[2,{exchange:l.WyvernProtocol.getExchangeContractAddress(this._networkName),maker:n,taker:S,quantity:o,makerRelayerFee:V,takerRelayerFee:Z,makerProtocolFee:X,takerProtocolFee:j,makerReferrerFee:J,waitingForBestCounterOrder:v,englishAuctionReservePrice:G?f.makeBigNumber(G):void 0,feeMethod:$,feeRecipient:Q,side:A.OrderSide.Sell,saleKind:W,target:L,howToCall:A.HowToCall.Call,calldata:D,replacementPattern:I,staticTarget:te,staticExtradata:re,paymentToken:K,basePrice:U,extra:H,listingTime:z.listingTime,expirationTime:z.expirationTime,salt:l.WyvernProtocol.generatePseudoRandomSalt(),metadata:{asset:w,schema:e.name}}]}}))}))},e.prototype._getStaticCallTargetAndExtraData=function(e){var t=e.asset,r=e.useTxnOriginStaticCall;return o(this,void 0,void 0,(function(){var e,n,o,d,l,h,m,y,w;return c(this,(function(c){switch(c.label){case 0:return e=[E.CHEEZE_WIZARDS_GUILD_ADDRESS.toLowerCase(),E.CHEEZE_WIZARDS_GUILD_RINKEBY_ADDRESS.toLowerCase()].includes(t.tokenAddress.toLowerCase()),n=t.tokenAddress.toLowerCase()==E.DECENTRALAND_ESTATE_ADDRESS.toLowerCase(),(o=this._networkName==A.Network.Main)&&!r?[2,{staticTarget:E.NULL_ADDRESS,staticExtradata:"0x"}]:e?(d=o?E.CHEEZE_WIZARDS_BASIC_TOURNAMENT_ADDRESS:E.CHEEZE_WIZARDS_BASIC_TOURNAMENT_RINKEBY_ADDRESS,[4,this.web3.eth.contract(v.CheezeWizardsBasicTournament).at(d)]):[3,3];case 1:return l=c.sent(),[4,f.rawCall(this.web3,{to:l.address,data:l.wizardFingerprint.getData(t.tokenId)})];case 2:return h=c.sent(),[2,{staticTarget:o?E.STATIC_CALL_CHEEZE_WIZARDS_ADDRESS:E.STATIC_CALL_CHEEZE_WIZARDS_RINKEBY_ADDRESS,staticExtradata:_.encodeCall(v.getMethod(v.StaticCheckCheezeWizards,"succeedIfCurrentWizardFingerprintMatchesProvidedWizardFingerprint"),[t.tokenId,h,r])}];case 3:return n&&o?(m=E.DECENTRALAND_ESTATE_ADDRESS,[4,this.web3.eth.contract(v.DecentralandEstates).at(m)]):[3,6];case 4:return y=c.sent(),[4,f.rawCall(this.web3,{to:y.address,data:y.getFingerprint.getData(t.tokenId)})];case 5:return w=c.sent(),[2,{staticTarget:E.STATIC_CALL_DECENTRALAND_ESTATES_ADDRESS,staticExtradata:_.encodeCall(v.getMethod(v.StaticCheckDecentralandEstates,"succeedIfCurrentEstateFingerprintMatchesProvidedEstateFingerprint"),[t.tokenId,w,r])}];case 6:return r?[2,{staticTarget:o?E.STATIC_CALL_TX_ORIGIN_ADDRESS:E.STATIC_CALL_TX_ORIGIN_RINKEBY_ADDRESS,staticExtradata:_.encodeCall(v.getMethod(v.StaticCheckTxOrigin,"succeedIfTxOriginMatchesHardcodedAddress"),[])}]:[2,{staticTarget:E.NULL_ADDRESS,staticExtradata:"0x"}];case 7:return[2]}}))}))},e.prototype._makeBundleBuyOrder=function(e){var t=e.assets,r=e.collection,n=e.quantities,d=e.accountAddress,h=e.startAmount,m=e.expirationTime,y=void 0===m?0:m,v=e.paymentTokenAddress,w=e.extraBountyBasisPoints,T=void 0===w?0:w,k=e.sellOrder,P=e.referrerAddress;return o(this,void 0,void 0,(function(){var e,o,m,w,S,N,F,R,B,x,C,O,L,D,I,W,M,U,H,K,G,z,Y,V,Z,X=this;return c(this,(function(c){switch(c.label){case 0:return d=f.validateAndFormatWalletAddress(this.web3,d),e=n.map((function(e,i){return l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(e),t[i].decimals||0)})),o=f.getWyvernBundle(t,t.map((function(a){return X._getSchema(a.schemaName)})),e),m=o.schemas.map((function(e){return X._getSchema(e)})),w=k?k.maker:E.NULL_ADDRESS,r?[4,this.api.getAsset(t[0])]:[3,2];case 1:return N=c.sent(),[3,3];case 2:N=void 0,c.label=3;case 3:return S=N,[4,this.computeFees({asset:S,extraBountyBasisPoints:T,side:A.OrderSide.Buy})];case 4:return F=c.sent(),R=F.totalBuyerFeeBasisPoints,B=F.totalSellerFeeBasisPoints,x=this._getBuyFeeParameters(R,B,k),C=x.makerRelayerFee,O=x.takerRelayerFee,L=x.makerProtocolFee,D=x.takerProtocolFee,I=x.makerReferrerFee,W=x.feeRecipient,M=x.feeMethod,U=_.encodeAtomicizedBuy(m,o.assets,d,this._wyvernProtocol,this._networkName),H=U.calldata,K=U.replacementPattern,[4,this._getPriceParameters(A.OrderSide.Buy,v,y,h)];case 5:return G=c.sent(),z=G.basePrice,Y=G.extra,V=G.paymentToken,Z=this._getTimeParameters(y),[2,{exchange:l.WyvernProtocol.getExchangeContractAddress(this._networkName),maker:d,taker:w,quantity:f.makeBigNumber(1),makerRelayerFee:C,takerRelayerFee:O,makerProtocolFee:L,takerProtocolFee:D,makerReferrerFee:I,waitingForBestCounterOrder:!1,feeMethod:M,feeRecipient:W,side:A.OrderSide.Buy,saleKind:A.SaleKind.FixedPrice,target:l.WyvernProtocol.getAtomicizerContractAddress(this._networkName),howToCall:A.HowToCall.DelegateCall,calldata:H,replacementPattern:K,staticTarget:E.NULL_ADDRESS,staticExtradata:"0x",paymentToken:V,basePrice:z,extra:Y,listingTime:Z.listingTime,expirationTime:Z.expirationTime,salt:l.WyvernProtocol.generatePseudoRandomSalt(),metadata:{bundle:o,referrerAddress:P}}]}}))}))},e.prototype._makeBundleSellOrder=function(e){var t=e.bundleName,r=e.bundleDescription,n=e.bundleExternalLink,d=e.assets,h=e.collection,m=e.quantities,y=e.accountAddress,v=e.startAmount,w=e.endAmount,T=e.listingTime,k=e.expirationTime,P=e.waitForHighestBid,S=e.englishAuctionReservePrice,N=void 0===S?0:S,F=e.paymentTokenAddress,R=e.extraBountyBasisPoints,B=e.buyerAddress;return o(this,void 0,void 0,(function(){var e,o,S,x,C,O,L,D,I,W,M,U,H,K,G,z,Y,V,Z,X,j,J,Q,$,ee,te,re,ae=this;return c(this,(function(c){switch(c.label){case 0:return y=f.validateAndFormatWalletAddress(this.web3,y),e=m.map((function(e,i){return l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(e),d[i].decimals||0)})),o=f.getWyvernBundle(d,d.map((function(a){return ae._getSchema(a.schemaName)})),e),S=o.schemas.map((function(e){return ae._getSchema(e)})),o.name=t,o.description=r,o.external_link=n,x=B!=E.NULL_ADDRESS,h?[4,this.api.getAsset(d[0])]:[3,2];case 1:return O=c.sent(),[3,3];case 2:O=void 0,c.label=3;case 3:return C=O,[4,this.computeFees({asset:C,side:A.OrderSide.Sell,isPrivate:x,extraBountyBasisPoints:R})];case 4:return L=c.sent(),D=L.totalSellerFeeBasisPoints,I=L.totalBuyerFeeBasisPoints,W=L.sellerBountyBasisPoints,M=_.encodeAtomicizedSell(S,o.assets,y,this._wyvernProtocol,this._networkName),U=M.calldata,H=M.replacementPattern,[4,this._getPriceParameters(A.OrderSide.Sell,F,k,v,w,P,N)];case 5:return K=c.sent(),G=K.basePrice,z=K.extra,Y=K.paymentToken,V=K.reservePrice,Z=this._getTimeParameters(k,T,P),X=null!=w&&w!==v?A.SaleKind.DutchAuction:A.SaleKind.FixedPrice,j=this._getSellFeeParameters(I,D,P,W),J=j.makerRelayerFee,Q=j.takerRelayerFee,$=j.makerProtocolFee,ee=j.takerProtocolFee,te=j.makerReferrerFee,re=j.feeRecipient,[2,{exchange:l.WyvernProtocol.getExchangeContractAddress(this._networkName),maker:y,taker:B,quantity:f.makeBigNumber(1),makerRelayerFee:J,takerRelayerFee:Q,makerProtocolFee:$,takerProtocolFee:ee,makerReferrerFee:te,waitingForBestCounterOrder:P,englishAuctionReservePrice:V?f.makeBigNumber(V):void 0,feeMethod:A.FeeMethod.SplitFee,feeRecipient:re,side:A.OrderSide.Sell,saleKind:X,target:l.WyvernProtocol.getAtomicizerContractAddress(this._networkName),howToCall:A.HowToCall.DelegateCall,calldata:U,replacementPattern:H,staticTarget:E.NULL_ADDRESS,staticExtradata:"0x",paymentToken:Y,basePrice:G,extra:z,listingTime:Z.listingTime,expirationTime:Z.expirationTime,salt:l.WyvernProtocol.generatePseudoRandomSalt(),metadata:{bundle:o}}]}}))}))},e.prototype._makeMatchingOrder=function(e){var t=this,r=e.order,o=e.accountAddress,c=e.recipientAddress;o=f.validateAndFormatWalletAddress(this.web3,o),c=f.validateAndFormatWalletAddress(this.web3,c);var d=function(){if("asset"in r.metadata){var e=t._getSchema(r.metadata.schema);return r.side==A.OrderSide.Buy?_.encodeSell(e,r.metadata.asset,c):_.encodeBuy(e,r.metadata.asset,c)}if("bundle"in r.metadata){var n=r.metadata.bundle,o=n.schemas?n.schemas.map((function(e){return t._getSchema(e)})):n.assets.map((function(){return t._getSchema("schema"in r.metadata?r.metadata.schema:void 0)})),d=r.side==A.OrderSide.Buy?_.encodeAtomicizedSell(o,r.metadata.bundle.assets,c,t._wyvernProtocol,t._networkName):_.encodeAtomicizedBuy(o,r.metadata.bundle.assets,c,t._wyvernProtocol,t._networkName);return{target:l.WyvernProtocol.getAtomicizerContractAddress(t._networkName),calldata:d.calldata,replacementPattern:d.replacementPattern}}throw new Error("Invalid order metadata")}(),h=d.target,m=d.calldata,y=d.replacementPattern,v=this._getTimeParameters(0),w=r.feeRecipient==E.NULL_ADDRESS?E.OPENSEA_FEE_RECIPIENT:E.NULL_ADDRESS,T={exchange:r.exchange,maker:o,taker:r.maker,quantity:r.quantity,makerRelayerFee:r.makerRelayerFee,takerRelayerFee:r.takerRelayerFee,makerProtocolFee:r.makerProtocolFee,takerProtocolFee:r.takerProtocolFee,makerReferrerFee:r.makerReferrerFee,waitingForBestCounterOrder:!1,feeMethod:r.feeMethod,feeRecipient:w,side:(r.side+1)%2,saleKind:A.SaleKind.FixedPrice,target:h,howToCall:r.howToCall,calldata:m,replacementPattern:y,staticTarget:E.NULL_ADDRESS,staticExtradata:"0x",paymentToken:r.paymentToken,basePrice:r.basePrice,extra:f.makeBigNumber(0),listingTime:v.listingTime,expirationTime:v.expirationTime,salt:l.WyvernProtocol.generatePseudoRandomSalt(),metadata:r.metadata};return n({},T,{hash:f.getOrderHash(T)})},e.prototype._validateMatch=function(e,t){var r=e.buy,n=e.sell,d=e.accountAddress,l=e.shouldValidateBuy,h=void 0!==l&&l,m=e.shouldValidateSell,y=void 0!==m&&m;return void 0===t&&(t=1),o(this,void 0,void 0,(function(){var e,o,l,m,v;return c(this,(function(c){switch(c.label){case 0:return c.trys.push([0,7,,10]),h?[4,this._validateOrder(r)]:[3,2];case 1:if(e=c.sent(),this.logger("Buy order is valid: "+e),!e)throw new Error("Invalid buy order. It may have recently been removed. Please refresh the page and try again!");c.label=2;case 2:return y?[4,this._validateOrder(n)]:[3,4];case 3:if(o=c.sent(),this.logger("Sell order is valid: "+o),!o)throw new Error("Invalid sell order. It may have recently been removed. Please refresh the page and try again!");c.label=4;case 4:return[4,w.requireOrdersCanMatch(this._getClientsForRead(t).wyvernProtocol,{buy:r,sell:n,accountAddress:d})];case 5:return l=c.sent(),this.logger("Orders matching: "+l),[4,w.requireOrderCalldataCanMatch(this._getClientsForRead(t).wyvernProtocol,{buy:r,sell:n})];case 6:return m=c.sent(),this.logger("Order calldata matching: "+m),[2,!0];case 7:if(v=c.sent(),t<=0)throw new Error("Error matching this listing: "+v.message+". Please contact the maker or try again later!");return[4,f.delay(500)];case 8:return c.sent(),[4,this._validateMatch({buy:r,sell:n,accountAddress:d,shouldValidateBuy:h,shouldValidateSell:y},t-1)];case 9:return[2,c.sent()];case 10:return[2]}}))}))},e.prototype._createEmailWhitelistEntry=function(e){var t=e.order,r=e.buyerEmail;return o(this,void 0,void 0,(function(){var e;return c(this,(function(n){switch(n.label){case 0:if(!(e="asset"in t.metadata?t.metadata.asset:void 0)||!e.id)throw new Error("Whitelisting only available for non-fungible assets.");return[4,this.api.postAssetWhitelist(e.address,e.id,r)];case 1:return n.sent(),[2]}}))}))},e.prototype._sellOrderValidationAndApprovals=function(e){var t=e.order,r=e.accountAddress;return o(this,void 0,void 0,(function(){var e,n,o,d;return c(this,(function(c){switch(c.label){case 0:return e="bundle"in t.metadata?t.metadata.bundle.assets:t.metadata.asset?[t.metadata.asset]:[],n="bundle"in t.metadata&&"schemas"in t.metadata.bundle?t.metadata.bundle.schemas:"schema"in t.metadata?[t.metadata.schema]:[],o=t.paymentToken,[4,this._approveAll({schemaNames:n,wyAssets:e,accountAddress:r})];case 1:return c.sent(),o==E.NULL_ADDRESS?[3,3]:(d=f.makeBigNumber(t.basePrice),[4,this.approveFungibleToken({accountAddress:r,tokenAddress:o,minimumAmount:d})]);case 2:c.sent(),c.label=3;case 3:return[4,this._wyvernProtocolReadOnly.wyvernExchange.validateOrderParameters_.callAsync([t.exchange,t.maker,t.taker,t.feeRecipient,t.target,t.staticTarget,t.paymentToken],[t.makerRelayerFee,t.takerRelayerFee,t.makerProtocolFee,t.takerProtocolFee,t.basePrice,t.extra,t.listingTime,t.expirationTime,t.salt],t.feeMethod,t.side,t.saleKind,t.howToCall,t.calldata,t.replacementPattern,t.staticExtradata,{from:r})];case 4:if(!c.sent())throw console.error(t),new Error("Failed to validate sell order parameters. Make sure you're on the right network!");return[2]}}))}))},e.prototype._approveOrder=function(e){return o(this,void 0,void 0,(function(){var t,r,n,d=this;return c(this,(function(l){switch(l.label){case 0:return t=e.maker,[4,this._computeGasPrice()];case 1:return r=l.sent(),!0,this._dispatch(A.EventType.ApproveOrder,{order:e,accountAddress:t}),[4,this._wyvernProtocol.wyvernExchange.approveOrder_.sendTransactionAsync([e.exchange,e.maker,e.taker,e.feeRecipient,e.target,e.staticTarget,e.paymentToken],[e.makerRelayerFee,e.takerRelayerFee,e.makerProtocolFee,e.takerProtocolFee,e.basePrice,e.extra,e.listingTime,e.expirationTime,e.salt],e.feeMethod,e.side,e.saleKind,e.howToCall,e.calldata,e.replacementPattern,e.staticExtradata,!0,{from:t,gasPrice:r})];case 2:return n=l.sent(),[4,this._confirmTransaction(n.toString(),A.EventType.ApproveOrder,"Approving order",(function(){return o(d,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this._validateOrder(e)];case 1:return[2,t.sent()]}}))}))}))];case 3:return l.sent(),[2,n]}}))}))},e.prototype._validateOrder=function(e){return o(this,void 0,void 0,(function(){return c(this,(function(t){switch(t.label){case 0:return[4,this._wyvernProtocolReadOnly.wyvernExchange.validateOrder_.callAsync([e.exchange,e.maker,e.taker,e.feeRecipient,e.target,e.staticTarget,e.paymentToken],[e.makerRelayerFee,e.takerRelayerFee,e.makerProtocolFee,e.takerProtocolFee,e.basePrice,e.extra,e.listingTime,e.expirationTime,e.salt],e.feeMethod,e.side,e.saleKind,e.howToCall,e.calldata,e.replacementPattern,e.staticExtradata,e.v||0,e.r||E.NULL_BLOCK_HASH,e.s||E.NULL_BLOCK_HASH)];case 1:return[2,t.sent()]}}))}))},e.prototype._approveAll=function(e){var t=e.schemaNames,r=e.wyAssets,n=e.accountAddress,d=e.proxyAddress;return o(this,void 0,void 0,(function(){var e,l,h=this;return c(this,(function(m){switch(m.label){case 0:return(e=d)?[3,2]:[4,this._getProxy(n)];case 1:e=m.sent(),m.label=2;case 2:return(d=e||void 0)?[3,4]:[4,this._initializeProxy(n)];case 3:d=m.sent(),m.label=4;case 4:return l=new Set,[2,Promise.all(r.map((function(e,i){return o(h,void 0,void 0,(function(){var r,o,h,m,y;return c(this,(function(c){switch(c.label){case 0:r=t[i],c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this._ownsAssetOnChain({accountAddress:n,proxyAddress:d,wyAsset:e,schemaName:r})];case 2:return o=c.sent(),[3,4];case 3:return c.sent(),o=!0,[3,4];case 4:if(!o)throw h="quantity"in e?e.quantity:1,console.error("Failed on-chain ownership check: "+n+" on "+r+":",e),new Error("You don't own enough to do that ("+h+" base units of "+e.address+(e.id?" token "+e.id:"")+")");switch(r){case A.WyvernSchemaName.ERC721:case A.WyvernSchemaName.ERC1155:case A.WyvernSchemaName.LegacyEnjin:case A.WyvernSchemaName.ENSShortNameAuction:return[3,5];case A.WyvernSchemaName.ERC20:return[3,7]}return[3,9];case 5:return m=e,[4,this.approveSemiOrNonFungibleToken({tokenId:m.id.toString(),tokenAddress:m.address,accountAddress:n,proxyAddress:d,schemaName:r,skipApproveAllIfTokenAddressIn:l})];case 6:return[2,c.sent()];case 7:return y=e,l.has(y.address)?[2,null]:(l.add(y.address),[4,this.approveFungibleToken({tokenAddress:y.address,accountAddress:n,proxyAddress:d})]);case 8:return[2,c.sent()];case 9:return[2]}}))}))})))]}}))}))},e.prototype._buyOrderValidationAndApprovals=function(e){var t=e.order,r=e.counterOrder,n=e.accountAddress;return o(this,void 0,void 0,(function(){var e,o,d;return c(this,(function(c){switch(c.label){case 0:return(e=t.paymentToken)==E.NULL_ADDRESS?[3,5]:[4,this.getTokenBalance({accountAddress:n,tokenAddress:e})];case 1:return o=c.sent(),d=f.makeBigNumber(t.basePrice),r?[4,this._getRequiredAmountForTakingSellOrder(r)]:[3,3];case 2:d=c.sent(),c.label=3;case 3:if(o.toNumber()<d.toNumber())throw e==h.tokens[this._networkName].canonicalWrappedEther.address?new Error("Insufficient balance. You may need to wrap Ether."):new Error("Insufficient balance.");return[4,this.approveFungibleToken({accountAddress:n,tokenAddress:e,minimumAmount:d})];case 4:c.sent(),c.label=5;case 5:return[4,this._wyvernProtocolReadOnly.wyvernExchange.validateOrderParameters_.callAsync([t.exchange,t.maker,t.taker,t.feeRecipient,t.target,t.staticTarget,t.paymentToken],[t.makerRelayerFee,t.takerRelayerFee,t.makerProtocolFee,t.takerProtocolFee,t.basePrice,t.extra,t.listingTime,t.expirationTime,t.salt],t.feeMethod,t.side,t.saleKind,t.howToCall,t.calldata,t.replacementPattern,t.staticExtradata,{from:n})];case 6:if(!c.sent())throw console.error(t),new Error("Failed to validate buy order parameters. Make sure you're on the right network!");return[2]}}))}))},e.prototype._ownsAssetOnChain=function(e){var t=e.accountAddress,r=e.proxyAddress,n=e.wyAsset,d=e.schemaName;return o(this,void 0,void 0,(function(){var e,o,l;return c(this,(function(c){switch(c.label){case 0:return e={tokenId:n.id||null,tokenAddress:n.address,schemaName:d},o=new T.BigNumber("quantity"in n?n.quantity:1),[4,this.getAssetBalance({accountAddress:t,asset:e})];case 1:return c.sent().greaterThanOrEqualTo(o)?[2,!0]:(l=r)?[3,3]:[4,this._getProxy(t)];case 2:l=c.sent(),c.label=3;case 3:return(r=l)?[4,this.getAssetBalance({accountAddress:r,asset:e})]:[3,5];case 4:if(c.sent().greaterThanOrEqualTo(o))return[2,!0];c.label=5;case 5:return[2,!1]}}))}))},e.prototype._getBuyFeeParameters=function(e,t,r){var n,o;return this._validateFees(e,t),r?(n=r.waitingForBestCounterOrder?f.makeBigNumber(r.makerRelayerFee):f.makeBigNumber(r.takerRelayerFee),o=r.waitingForBestCounterOrder?f.makeBigNumber(r.takerRelayerFee):f.makeBigNumber(r.makerRelayerFee)):(n=f.makeBigNumber(e),o=f.makeBigNumber(t)),{makerRelayerFee:n,takerRelayerFee:o,makerProtocolFee:f.makeBigNumber(0),takerProtocolFee:f.makeBigNumber(0),makerReferrerFee:f.makeBigNumber(0),feeRecipient:E.OPENSEA_FEE_RECIPIENT,feeMethod:A.FeeMethod.SplitFee}},e.prototype._getSellFeeParameters=function(e,t,r,n){void 0===n&&(n=0),this._validateFees(e,t);var o=r?E.NULL_ADDRESS:E.OPENSEA_FEE_RECIPIENT;return{makerRelayerFee:r?f.makeBigNumber(e):f.makeBigNumber(t),takerRelayerFee:r?f.makeBigNumber(t):f.makeBigNumber(e),makerProtocolFee:f.makeBigNumber(0),takerProtocolFee:f.makeBigNumber(0),makerReferrerFee:f.makeBigNumber(n),feeRecipient:o,feeMethod:A.FeeMethod.SplitFee}},e.prototype._validateFees=function(e,t){var r=E.INVERSE_BASIS_POINT/100;if(e>E.INVERSE_BASIS_POINT||t>E.INVERSE_BASIS_POINT)throw new Error("Invalid buyer/seller fees: must be less than "+r+"%");if(e<0||t<0)throw new Error("Invalid buyer/seller fees: must be at least 0%")},e.prototype._getTimeParameters=function(e,t,r){void 0===r&&(r=!1);var n=Math.round(Date.now()/1e3+E.MIN_EXPIRATION_SECONDS),o=Math.round(Date.now()/1e3);if(0!=e&&e<n)throw new Error("Expiration time must be at least "+E.MIN_EXPIRATION_SECONDS+" seconds from now, or zero (non-expiring).");if(t&&t<o)throw new Error("Listing time cannot be in the past.");if(t&&0!=e&&t>=e)throw new Error("Listing time must be before the expiration time.");if(r&&0==e)throw new Error("English auctions must have an expiration time.");if(r&&t)throw new Error("Cannot schedule an English auction for the future.");if(parseInt(e.toString())!=e)throw new Error("Expiration timestamp must be a whole number of seconds");return r?(t=e,e+=E.ORDER_MATCHING_LATENCY_SECONDS):t=t||Math.round(Date.now()/1e3-100),{listingTime:f.makeBigNumber(t),expirationTime:f.makeBigNumber(e)}},e.prototype._getPriceParameters=function(e,t,r,n,d,h,m){return void 0===h&&(h=!1),o(this,void 0,void 0,(function(){var o,y,v,_,w,T,k,P;return c(this,(function(c){switch(c.label){case 0:return o=null!=d?n-d:0,y=t.toLowerCase(),v=t==E.NULL_ADDRESS,[4,this.api.getPaymentTokens({address:y})];case 1:if(_=c.sent().tokens,w=_[0],isNaN(n)||null==n||n<0)throw new Error("Starting price must be a number >= 0");if(!v&&!w)throw new Error("No ERC-20 token found for '"+y+"'");if(v&&h)throw new Error("English auctions must use wrapped ETH or an ERC-20 token.");if(v&&e===A.OrderSide.Buy)throw new Error("Offers must use wrapped ETH or an ERC-20 token.");if(o<0)throw new Error("End price must be less than or equal to the start price.");if(o>0&&0==r)throw new Error("Expiration time must be set if order will change in price.");if(m&&!h)throw new Error("Reserve prices may only be set on English auctions.");if(m&&m<n)throw new Error("Reserve price must be greater than or equal to the start amount.");return T=v?f.makeBigNumber(this.web3.toWei(n,"ether")).round():l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(n),w.decimals),k=v?f.makeBigNumber(this.web3.toWei(o,"ether")).round():l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(o),w.decimals),P=m?v?f.makeBigNumber(this.web3.toWei(m,"ether")).round():l.WyvernProtocol.toBaseUnitAmount(f.makeBigNumber(m),w.decimals):void 0,[2,{basePrice:T,extra:k,paymentToken:y,reservePrice:P}]}}))}))},e.prototype._getMetadata=function(e,t){var r=t||e.metadata.referrerAddress;if(r&&P.isValidAddress(r))return r},e.prototype._atomicMatch=function(e){var t=e.buy,r=e.sell,n=e.accountAddress,d=e.metadata,l=void 0===d?E.NULL_BLOCK_HASH:d;return o(this,void 0,void 0,(function(){var e,o,d,h,m,y,v,f,_,T;return c(this,(function(c){switch(c.label){case 0:return o=!0,d=!0,r.maker.toLowerCase()!=n.toLowerCase()?[3,2]:[4,this._sellOrderValidationAndApprovals({order:r,accountAddress:n})];case 1:return c.sent(),d=!1,[3,6];case 2:return t.maker.toLowerCase()!=n.toLowerCase()?[3,6]:[4,this._buyOrderValidationAndApprovals({order:t,counterOrder:r,accountAddress:n})];case 3:return c.sent(),o=!1,t.paymentToken!=E.NULL_ADDRESS?[3,5]:[4,this._getRequiredAmountForTakingSellOrder(r)];case 4:e=c.sent(),c.label=5;case 5:return[3,6];case 6:return[4,this._validateMatch({buy:t,sell:r,accountAddress:n,shouldValidateBuy:o,shouldValidateSell:d})];case 7:c.sent(),this._dispatch(A.EventType.MatchOrders,{buy:t,sell:r,accountAddress:n,matchMetadata:l}),m={from:n,value:e},y=[[t.exchange,t.maker,t.taker,t.feeRecipient,t.target,t.staticTarget,t.paymentToken,r.exchange,r.maker,r.taker,r.feeRecipient,r.target,r.staticTarget,r.paymentToken],[t.makerRelayerFee,t.takerRelayerFee,t.makerProtocolFee,t.takerProtocolFee,t.basePrice,t.extra,t.listingTime,t.expirationTime,t.salt,r.makerRelayerFee,r.takerRelayerFee,r.makerProtocolFee,r.takerProtocolFee,r.basePrice,r.extra,r.listingTime,r.expirationTime,r.salt],[t.feeMethod,t.side,t.saleKind,t.howToCall,r.feeMethod,r.side,r.saleKind,r.howToCall],t.calldata,r.calldata,t.replacementPattern,r.replacementPattern,t.staticExtradata,r.staticExtradata,[t.v||0,r.v||0],[t.r||E.NULL_BLOCK_HASH,t.s||E.NULL_BLOCK_HASH,r.r||E.NULL_BLOCK_HASH,r.s||E.NULL_BLOCK_HASH,l]],c.label=8;case 8:return c.trys.push([8,11,,12]),[4,this._wyvernProtocolReadOnly.wyvernExchange.atomicMatch_.estimateGasAsync(y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8],y[9],y[10],m)];case 9:return v=c.sent(),f=m,[4,this._computeGasPrice()];case 10:return f.gasPrice=c.sent(),m.gas=this._correctGasAmount(v),[3,12];case 11:throw _=c.sent(),console.error("Failed atomic match with args: ",y,_),new Error('Oops, the Ethereum network rejected this transaction :( The OpenSea devs have been alerted, but this problem is typically due an item being locked or untransferrable. The exact error was "'+_.message.substr(0,w.MAX_ERROR_LENGTH)+'..."');case 12:return c.trys.push([12,14,,15]),this.logger("Fulfilling order with gas set to "+m.gas),[4,this._wyvernProtocol.wyvernExchange.atomicMatch_.sendTransactionAsync(y[0],y[1],y[2],y[3],y[4],y[5],y[6],y[7],y[8],y[9],y[10],m)];case 13:return h=c.sent(),[3,15];case 14:throw T=c.sent(),console.error(T),this._dispatch(A.EventType.TransactionDenied,{error:T,buy:t,sell:r,accountAddress:n,matchMetadata:l}),new Error('Failed to authorize transaction: "'+(T.message?T.message:"user denied")+'..."');case 15:return[2,h]}}))}))},e.prototype._getRequiredAmountForTakingSellOrder=function(e){return o(this,void 0,void 0,(function(){var t,r,n,o;return c(this,(function(c){switch(c.label){case 0:return[4,this.getCurrentPrice(e)];case 1:return t=c.sent(),r=f.estimateCurrentPrice(e),n=T.BigNumber.max(t,r),e.takerRelayerFee=f.makeBigNumber(e.takerRelayerFee),o=e.takerRelayerFee.div(E.INVERSE_BASIS_POINT),[2,o.times(n).plus(n).ceil()]}}))}))},e.prototype._authorizeOrder=function(e){return o(this,void 0,void 0,(function(){var t,r,n,o;return c(this,(function(c){switch(c.label){case 0:return t=e.hash,r=e.maker,this._dispatch(A.EventType.CreateOrder,{order:e,accountAddress:e.maker}),[4,f.isContractAddress(this.web3,r)];case 1:n=c.sent(),c.label=2;case 2:return c.trys.push([2,7,,8]),n?[4,this._approveOrder(e)]:[3,4];case 3:return c.sent(),[2,null];case 4:return[4,f.personalSignAsync(this.web3,t,r)];case 5:return[2,c.sent()];case 6:return[3,8];case 7:throw o=c.sent(),this._dispatch(A.EventType.OrderDenied,{order:e,accountAddress:r}),o;case 8:return[2]}}))}))},e.prototype._getSchema=function(e){var t=e||A.WyvernSchemaName.ERC721,r=h.schemas[this._networkName].filter((function(s){return s.name==t}))[0];if(!r)throw new Error("Trading for this asset ("+t+") is not yet supported. Please contact us or check back later!");return r},e.prototype._dispatch=function(e,data){this._emitter.emit(e,data)},e.prototype._getClientsForRead=function(e){return void 0===e&&(e=1),e>0?{web3:this.web3,wyvernProtocol:this._wyvernProtocol}:{web3:this.web3ReadOnly,wyvernProtocol:this._wyvernProtocolReadOnly}},e.prototype._confirmTransaction=function(e,t,r,d){return o(this,void 0,void 0,(function(){var o,l;return c(this,(function(c){switch(c.label){case 0:return o={transactionHash:e,event:t},this.logger("Transaction started: "+r),e!=E.NULL_BLOCK_HASH?[3,4]:(this._dispatch(A.EventType.TransactionCreated,{event:t}),d?[3,2]:(this.logger("Unknown action, waiting 1 minute: "+r),[4,f.delay(6e4)]));case 1:return c.sent(),[2];case 2:return[4,this._pollCallbackForConfirmation(t,r,d)];case 3:return[2,c.sent()];case 4:return c.trys.push([4,6,,7]),this._dispatch(A.EventType.TransactionCreated,o),[4,f.confirmTransaction(this.web3,e)];case 5:return c.sent(),this.logger("Transaction succeeded: "+r),this._dispatch(A.EventType.TransactionConfirmed,o),[3,7];case 6:throw l=c.sent(),this.logger("Transaction failed: "+r),this._dispatch(A.EventType.TransactionFailed,n({},o,{error:l})),l;case 7:return[2]}}))}))},e.prototype._pollCallbackForConfirmation=function(e,t,r){return o(this,void 0,void 0,(function(){var n=this;return c(this,(function(d){return[2,new Promise((function(d,l){return o(n,void 0,void 0,(function(){var n,h=this;return c(this,(function(m){return 60,[2,(n=function(m){return o(h,void 0,void 0,(function(){return c(this,(function(o){switch(o.label){case 0:return[4,r()];case 1:return o.sent()?(this.logger("Transaction succeeded: "+t),this._dispatch(A.EventType.TransactionConfirmed,{event:e}),[2,d()]):m<=0?[2,l()]:(m%10==0&&this.logger("Tested transaction "+(60-m+1)+" times: "+t),[4,f.delay(5e3)]);case 2:return o.sent(),[2,n(m-1)]}}))}))})(60)]}))}))}))]}))}))},e}();t.OpenSeaPort=S}}]);